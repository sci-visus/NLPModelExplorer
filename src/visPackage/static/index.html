<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>The HTML5 Herald</title>
  <meta name="description" content="The HTML5 Herald">
  <meta name="author" content="SitePoint">

  <link rel="stylesheet" href="css/styles.css?v=1.0">

  <!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.js"></script>
  <![endif]-->
</head>

<body>
    <div id="wrapper">
    <div id="layoutContainer"></div>
    </div>

    <script>
    var panelMetaInfo = {
      'Prediction': ['prediction_view', 'predictionComponent'],
      'Attention': ['attention_view','attentionComponent'],
      'Sentence': ['sentence_view','sentenceComponent']
    };

    var config = {
        settings: {
          showPopoutIcon: true,
          // showPopoutIcon: false,
          showCloseIcon: true
        },
        content: [{
          type: 'row',
          content: [
            {
              type: 'column',
              content: [
                {
                  type: 'component',
                  componentName: 'Prediction',
                  componentState: {
                    route: 'template_view',
                    name: 'predictionComponent'
                  }
                },
                {
                  type: 'component',
                  componentName: 'Attention',
                  componentState: {
                    route: 'template_view',
                    name: 'sentenceComponent'
                  }
                }
              ]
            },
            {
              type: 'column',
              content: [
                {
                  type: 'component',
                  componentName: 'Sentence',
                  componentState: {
                    route: 'neighborhood_view',
                    name: 'neighborhoodComponent'
                  }
                }
              ]
            }
          ]
        }]
      };

    //for lookup component class on-the-fly
    var constructorMap = {
      predictionComponent: predictionComponent,
      attentionComponent: attentionComponent,
      sentenceComponent: sentenceComponent
    }

    function registerComponent(appLayout, name) {
      //register factory callback
      appLayout.registerComponent(name, function(container, componentState) {
        // console.log("loading -- ", componentState);
        //popout test
        // console.log("container constructor:", componentState.name);
        // container.getElement().html( '<h2>' + componentState.name + '</h2>' );

       $.get('/views/' + componentState.route,
          function(template){
            // var uuid = guid();
            var uuid = uuidv1();
            var data={id: "div_"+uuid};
            var htmlComponent = Mustache.render(template, data);
            //create panel component
            var panel = container.getElement();
            panel.html(htmlComponent)
            // var panel = new window[componentState.name](uuid);
            //storge the object with panel
            var component = new constructorMap[componentState.name](uuid);
            panel.data("component", component);
            container.on("resize", component.resize.bind(component));
          });
      });
    }

    function insertPanel(name) {
      var newItemConfig = panelItemConfig[name];
      appLayout.root.contentItems[0].addChild(newItemConfig);
    }
    //////////////////////create layout ///////////////////////
    var appLayout = new window.GoldenLayout(config, $('#layoutContainer'));

    //register components
    for (key in panelMetaInfo) {
      if (panelMetaInfo.hasOwnProperty(key)) {
        // addMenuItem(key, panelMetaInfo[key][0], panelMetaInfo[key][1]);
        registerComponent(appLayout, key);
      }
    }

    appLayout.init()
    //handle whole window resize
    window.addEventListener('resize', function() {
      appLayout.updateSize();
    })

    window.onbeforeunload = function(e) {
      console.log("@@@@@@@@@@@ reset module on server @@@@@@@@@\n");
      $.get("/reset/", d=>console.log(d));
    };
    </script>
</body>
</html>
