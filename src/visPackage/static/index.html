<!doctype html>

<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- <link type="text/css" rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"> -->
    <!-- <link type="text/css" rel="stylesheet" href="https://golden-layout.com/files/latest/css/goldenlayout-base.css" /> -->
    <link type="text/css" rel="stylesheet" href="../../static/css/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="../../static/css/goldenlayout-base.css" />
    <link type="text/css" rel="stylesheet" href="../../static/css/goldenlayout-light-theme.css" />

    <script type="text/javascript" src="../../static/lib/d3.v3.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../static/lib/jquery.min.js"></script>
    <script type="text/javascript" src="../../static/lib/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../static/lib/goldenlayout.min.js"></script>
    <script type="text/javascript" src="../../static/lib/socket.io.min.js"></script>

    <!-- <script type="text/javascript" src="../../static/components/baseComponent.js"></script> -->
    <script type="text/javascript" src="../../static/components/predictionComponent.js"></script>
    <script type="text/javascript" src="../../static/components/sentenceComponent.js"></script>
</head>

<body>
    <div id="wrapper">
    <div id="layoutContainer"></div>
    </div>

    <script>
    var panelMetaInfo = {
      'Prediction': ['prediction_view', 'predictionComponent'],
      'Attention': ['attention_view','attentionComponent'],
      'Sentence': ['sentence_view','sentenceComponent']
    };

    var config = {
        settings: {
          showPopoutIcon: true,
          // showPopoutIcon: false,
          showCloseIcon: true
        },
        content: [{
          type: 'row',
          content: [
            {
              type: 'column',
              content: [
                {
                  type: 'component',
                  componentName: 'Prediction',
                  componentState: {
                    route: 'template_view',
                    name: 'predictionComponent'
                  }
                },
                {
                  type: 'component',
                  componentName: 'Attention',
                  componentState: {
                    route: 'template_view',
                    name: 'sentenceComponent'
                  }
                }
              ]
            },
            {
              type: 'column',
              content: [
                {
                  type: 'component',
                  componentName: 'Sentence',
                  componentState: {
                    route: 'neighborhood_view',
                    name: 'neighborhoodComponent'
                  }
                }
              ]
            }
          ]
        }]
      };

    //for lookup component class on-the-fly
    var constructorMap = {
      predictionComponent: predictionComponent,
      attentionComponent: attentionComponent,
      sentenceComponent: sentenceComponent
    }

    function registerComponent(appLayout, name) {
      //register factory callback
      appLayout.registerComponent(name, function(container, componentState) {
        // console.log("loading -- ", componentState);
        //popout test
        // console.log("container constructor:", componentState.name);
        // container.getElement().html( '<h2>' + componentState.name + '</h2>' );

       $.get('/views/' + componentState.route,
          function(template){
            // var uuid = guid();
            var uuid = uuidv1();
            var data={id: "div_"+uuid};
            var htmlComponent = Mustache.render(template, data);
            //create panel component
            var panel = container.getElement();
            panel.html(htmlComponent)
            // var panel = new window[componentState.name](uuid);
            //storge the object with panel
            var component = new constructorMap[componentState.name](uuid);
            panel.data("component", component);
            container.on("resize", component.resize.bind(component));
          });
      });
    }

    function insertPanel(name) {
      var newItemConfig = panelItemConfig[name];
      appLayout.root.contentItems[0].addChild(newItemConfig);
    }
    //////////////////////create layout ///////////////////////
    var appLayout = new window.GoldenLayout(config, $('#layoutContainer'));

    //register components
    for (key in panelMetaInfo) {
      if (panelMetaInfo.hasOwnProperty(key)) {
        // addMenuItem(key, panelMetaInfo[key][0], panelMetaInfo[key][1]);
        registerComponent(appLayout, key);
      }
    }

    appLayout.init()
    //handle whole window resize
    window.addEventListener('resize', function() {
      appLayout.updateSize();
    })

    window.onbeforeunload = function(e) {
      console.log("@@@@@@@@@@@ reset module on server @@@@@@@@@\n");
      $.get("/reset/", d=>console.log(d));
    };
    </script>
</body>
</html>
